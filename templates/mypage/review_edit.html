{% extends "base.html" %}

{% block content %}

<div class="container my-5">
  <div class="card shadow-sm rounded p-4" style="background-color: #2c2c2c; color: #e0e0e0; transition: box-shadow 0.3s;">
    <h3 class="mb-4 text-center" style="color: #f5f5f5;">🎬 리뷰 수정</h3>
    <div class="row g-0">
      <div class="col-md-4">
        {% if movie.poster %}
        <img
          src="{{ movie.poster }}"
          alt="{{ movie.title }} 포스터"
          class="img-fluid rounded-start"
          style="object-fit: cover; height: 100%"
        />
        {% else %}
        <div
          class="d-flex align-items-center justify-content-center h-100"
          style="background-color: #2c2c2c; color: #e0e0e0; font-size: 1.2rem;"
        >
          포스터 없음
        </div>
        {% endif %}
      </div>
      <div class="col-md-8 content-section">
        <div class="card-body">
          <h2 class="card-title mb-3" style="color: #f5f5f5;">{{ movie.title }}</h2>
          <p class="card-text"><strong>감독:</strong> {{ movie.director }}</p>
          <p class="card-text"><strong>장르:</strong> {{ movie.genre }}</p>
          <p class="card-text">
            <strong>개봉일:</strong> {{ movie.release_date|date:"Y년 m월 d일" }}
          </p>
          <p class="card-text">
            <strong>별점:</strong>
            <span class="badge bg-warning" style="color: #212121 !important;">{{ movie.rating }} / 5.0</span>
          </p>
          <p class="card-text">
            <strong>내용:</strong> {{ movie.description }}
          </p>
        </div>
        <form
          method="post"
          action="{% url 'mypage:review_edit' user.username review_id %}"
        >
          {% csrf_token %}
          {% include "form_errors.html" %}

          <!-- 리뷰 내용 -->
          <div class="mb-4">
            <label for="content" class="form-label fw-bold" style="color: #f5f5f5;">리뷰 내용</label>
            <textarea
              name="content"
              id="content"
              class="form-control"
              rows="8"
              placeholder="리뷰를 작성해주세요."
              style="background-color: #444444; color: #e0e0e0; border-color: #555555; transition: border-color 0.3s;"
            >
{{ form.content.value|default_if_none:"" }}</textarea>
          </div>

          <!-- 별점 UI -->
          <div class="mb-4">
            <label class="form-label fw-bold" style="color: #f5f5f5;">평점</label>
            <div class="star-rating" style="display: flex; gap: 8px">
              {% for i in "12345" %}
              <label class="star" data-value="{{ i }}">★</label>
              {% endfor %}
            </div>
            <input
              type="hidden"
              name="score"
              id="id_score"
              value="{{ form.score.value|default:'0' }}"
            />
          </div>

          <!-- 버튼 -->
          <div class="d-grid">
            <button
              type="submit"
              class="btn btn-lg"
              style="background-color: #1e88e5; color: #e0e0e0; border: none; transition: background-color 0.3s;"
              onmouseover="this.style.backgroundColor='#1565c0'"
              onmouseout="this.style.backgroundColor='#1e88e5'"
            >
              💾 저장하기
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- 스타일 -->
<style>
  .star-rating {
    display: flex;
    gap: 8px;
  }

  .star {
    font-size: 2rem;
    cursor: pointer;
    color: #757575;
    transition: color 0.2s;
  }

  .star.selected,
  .star.hovered {
    color: #ffca28;
  }

  /* 텍스트 입력 필드 포커스 효과 */
  .form-control:focus {
    border-color: #1e88e5 !important;
    box-shadow: 0 0 5px rgba(30, 136, 229, 0.5) !important;
  }

  /* 카드 호버 효과 */
  .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  /* 오른쪽 콘텐츠 여백 */
  .content-section {
    padding-left: 10px;
  }
</style>

<!-- 스크립트 -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll(".star-rating .star");
    const hiddenInput = document.getElementById("id_score");

    // ⭐️ 현재 저장된 값 가져오기
    let currentValue = parseInt(hiddenInput.value);

    // 별 상태 업데이트 함수
    function updateStars(value, className) {
      stars.forEach((s) => {
        s.classList.remove(className);
        if (parseInt(s.dataset.value) <= value) {
          s.classList.add(className);
        }
      });
    }

    // ⭐️ 초기 점수 반영
    if (!isNaN(currentValue) && currentValue > 0) {
      updateStars(currentValue, "selected");
    }

    // ⭐️ 클릭 이벤트
    stars.forEach((star) => {
      star.addEventListener("click", () => {
        const value = parseInt(star.dataset.value);
        hiddenInput.value = value;
        currentValue = value;
        updateStars(value, "selected");
      });

      // 마우스 올리면 hover 표시
      star.addEventListener("mouseenter", () => {
        const value = parseInt(star.dataset.value);
        updateStars(value, "hovered");
      });

      // 마우스 나가면 hover 제거
      star.addEventListener("mouseleave", () => {
        updateStars(currentValue, "selected"); // hover 지우고 기존 값 유지
        stars.forEach((s) => s.classList.remove("hovered"));
      });
    });
  });
</script>

{% endblock %}