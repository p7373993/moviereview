{% extends "base.html" %}

{% block content %}
{% comment %} 포스터 감도 장르 개봉일 리뷰들 {% endcomment %}
<div class="container my-5">
  <!-- 영화 정보 -->
  <div class="card shadow-sm mb-5" style="background-color: #2c2c2c; color: #e0e0e0;">
    <div class="row g-0">
      <div class="col-md-4">
        {% if movie.poster %}
        <img
          src="{{ movie.poster }}"
          alt="{{ movie.title }} 포스터"
          class="img-fluid rounded-start"
          style="object-fit: cover; height: 100%"
        />
        {% else %}
        <div
          class="d-flex align-items-center justify-content-center h-100"
          style="background-color: #2c2c2c; color: #e0e0e0; font-size: 1.2rem;"
        >
          포스터 없음
        </div>
        {% endif %}
      </div>
      <div class="col-md-8">
        <div class="card-body">
          <h2 class="card-title mb-3">{{ movie.title }}</h2>
          <p class="card-text"><strong>감독:</strong> {{ movie.director }}</p>
          <p class="card-text"><strong>장르:</strong> {{ movie.genre }}</p>
          <p class="card-text">
            <strong>개봉일:</strong> {{ movie.release_date|date:"Y년 m월 d일" }}
          </p>
          <p class="card-text">
            <div class="movie-star-rating" style="display: flex; gap: 8px;">
              {% with rating_int=movie.rating|floatformat:"0"|add:"0" %}
              {% for i in "12345" %}
              <span class="star {% if i|add:'0' <= rating_int %}selected{% endif %}">★</span>
              {% endfor %}

              {% endwith %}
            </div>
          </p>
          <p class="card-text">
            <strong>내용:</strong> {{ movie.description }}
          </p>
        </div>
      </div>
    </div>
  </div>
  {% comment %} 리뷰 {% endcomment %}
  <h5 class="border-bottom my-3 py-2" style="color: #f5f5f5;">
    {{movie.reviews.count}}개의 리뷰가 있습니다.
  </h5>
  {% for review in movie.reviews.all %}
  <div class="card my-3" style="background-color: #333333; color: #e0e0e0;">
    <!-- 작성자 정보 -->
    <div class="card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <strong
          class="text-primary"
          style="font-size: 1.5rem; font-weight: bold; margin-right: 15px"
        >
          {{ review.author }}
        </strong>
      </div>
      <div class="badge bg-light text-dark p-2">
        {{ review.created_at|date:"Y년 m월 d일 H:i" }}
      </div>
    </div>

    <div class="card-body">
      <!-- 리뷰 내용 -->
      <div class="card-text" style="white-space: pre-line">
        {{ review.content }}
      </div>

      <!-- 별점 -->
      <div class="d-flex justify-content-start align-items-center mt-2">
        <div class="review-star-rating" style="display: flex; gap: 8px;">
          {% for i in "12345" %}
          <span class="star {% if i|add:'0' <= review.score %}selected{% endif %}">★</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- 리뷰 작성 폼 -->
  <div class="card shadow-sm p-4" style="background-color: #333333; color: #e0e0e0;">
    <h3 class="mb-4">리뷰 작성</h3>
    <form method="POST" action="{% url 'mypage:review_create' movie.id %}">
      {% csrf_token %}
      {% include "form_errors.html" %}
      <div class="mb-3">
        <label for="content" class="form-label fw-bold">리뷰 내용</label>
        <textarea
          class="form-control"
          id="content"
          name="content"
          rows="5"
          placeholder="영화에 대한 당신의 생각을 공유하세요!"
          required
          style="background-color: #444444; color: #e0e0e0; border-color: #555555; transition: border-color 0.3s;"
        >
{{ form.content.value|default_if_none:"" }}</textarea>
      </div>
      <div class="mb-4">
        <label class="form-label fw-bold">평점</label>
        <div class="star-rating" style="display: flex; gap: 8px">
          {% for i in "12345" %}
          <label class="star" data-value="{{ i }}">★</label>
          {% endfor %}
        </div>
        <input type="hidden" name="score" id="id_score" />
      </div>
      <div class="d-flex justify-content-end">
        <button
          type="submit"
          class="btn btn-primary btn-lg"
          style="background-color: #1e88e5; border: none; transition: background-color 0.3s;"
          onmouseover="this.style.backgroundColor='#1565c0'"
          onmouseout="this.style.backgroundColor='#1e88e5'"
        >
          리뷰 제출
        </button>
      </div>
    </form>
  </div>
</div>
<!-- 스타일 -->
<style>
  .star-rating, .movie-star-rating, .review-star-rating {
    display: flex;
    gap: 8px;
  }

  .star {
    font-size: 2rem;
    color: #757575;
    transition: color 0.2s;
  }

  .star-rating .star {
    cursor: pointer;
  }

  .movie-star-rating .star, .review-star-rating .star {
    cursor: default;
  }

  .star.selected,
  .star.hovered {
    color: #ffca28 !important;
  }

  /* 텍스트 입력 필드 포커스 효과 */
  .form-control:focus {
    border-color: #1e88e5 !important;
    box-shadow: 0 0 5px rgba(30, 136, 229, 0.5) !important;
  }
</style>

<!-- 스크립트 -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const stars = document.querySelectorAll(".star-rating .star");
    const hiddenInput = document.getElementById("id_score");

    // ⭐️ 현재 저장된 값 가져오기
    let currentValue = parseInt(hiddenInput.value);

    // 별 상태 업데이트 함수
    function updateStars(value, className) {
      stars.forEach((s) => {
        s.classList.remove(className);
        if (parseInt(s.dataset.value) <= value) {
          s.classList.add(className);
        }
      });
    }

    // ⭐️ 초기 점수 반영
    if (!isNaN(currentValue) && currentValue > 0) {
      updateStars(currentValue, "selected");
    }

    // ⭐️ 클릭 이벤트
    stars.forEach((star) => {
      star.addEventListener("click", () => {
        const value = parseInt(star.dataset.value);
        hiddenInput.value = value;
        currentValue = value;
        updateStars(value, "selected");
      });

      // 마우스 올리면 hover 표시
      star.addEventListener("mouseenter", () => {
        const value = parseInt(star.dataset.value);
        updateStars(value, "hovered");
      });

      // 마우스 나가면 hover 제거
      star.addEventListener("mouseleave", () => {
        updateStars(currentValue, "selected"); // hover 지우고 기존 값 유지
        stars.forEach((s) => s.classList.remove("hovered"));
      });
    });
  });
</script>

{% endblock %}